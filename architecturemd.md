# 进程内微服务架构
## 总览

我们用一张图开始这章的内容。

![进程内微服务架构](inprocess-microservices.png)

在上图中，`management node`作为一个独立的进程，是所有微服务的container，用于管理微服务的生命周期，提供统一的服务监控和HA（高可靠）等功能。图中的每一个单独的深蓝色方块都是一个独立的服务，根据功能的不同，在逻辑上归纳为：计算服务、存储服务、网络服务以及其它服务。虽然运行在同一进程中，所有服务在代码逻辑上仍然高度松耦合，服务之间通过外部消息总线通信，跟运行在独立进程中的微服务架构类似。

如果你熟悉传统微服务架构，你一定听过诸如“API Gateway”、“Self Registration”、“Client-side Delivery”、“Server-side Delivery”这样的词汇，它们在ZStack的微服务架构中都能找到，有些的实现还更为简单精巧。让你头疼的监控、高可靠、配置等诸多问题则不复存在，一切都由管理节点进程代为处理，开发人员只需要专心实现服务的业务逻辑即可。

## 要么没有，要么全有

我曾多次在技术交流中给国内主流公有云、互联网公司的技术团队讲解这个设计，收获的最多的一个问题是：如果某个服务存在性能瓶颈，在这个架构中无法对单一服务进行横向扩展。凑巧的是，提出这个问题的朋友都是来自OpenStack技术团队，可见“能够对单服务横向扩展”是OpenStack宣称的一个架构优势。

是的，在这个架构中，进程一旦启动就会加载所有服务，你不能选择性的加载一部分服务，要么没有，要么全有。你也不能对特定服务进行单独横向扩展，只能横向扩展管理节点进程，这样所有的服务都会获得相同程度的横向扩展。这听起来似乎不灵活也不合理，我已经听见你在心里这么说了。当你读到后面的章节时，你会发现在ZStack架构中，用户完全通过更改XML配置文件，实现只运行部分服务以及横向扩展特定服务，但我不建议用户这么做，原因如下：

### 核心服务缺一不可

任何软件都存在一组核心模块/服务，缺少任何一个都会导致整个系统不工作，IaaS亦然。目前为止，ZStack的服务绝大多数都是核心服务，例如虚拟机服务、物理机服务、主存储服务、镜像服务等；一些非核心服务，例如搜索服务，虽然不加载也不会影响整体功能，但会极大的损伤用户体验，甚至导致某些外围组件（例如UI）不工作。
